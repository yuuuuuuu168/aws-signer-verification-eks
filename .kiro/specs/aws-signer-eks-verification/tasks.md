# 実装計画: AWS Signer EKS検証環境

## 概要

本実装計画では、AWS Signerを使用したコンテナイメージの署名検証環境を構築します。Terraformでインフラストラクチャを自動構築し、Kyvernoで署名検証を実施する完全な検証環境を提供します。

## タスク

- [x] 1. Terraformプロジェクトの初期化
  - プロジェクトディレクトリ構造を作成
  - versions.tfでプロバイダーバージョンを定義（AWS Provider: 最新のGA版を使用）
  - variables.tfで入力変数を定義
  - outputs.tfで出力値を定義
  - _要件: 3.1, 3.2_

- [ ] 2. VPCとネットワークリソースの実装
  - [x] 2.1 VPCとサブネットの作成
    - vpc.tfを作成
    - VPC、パブリックサブネット×2、プライベートサブネット×2を定義
    - 適切なタグを設定
    - _要件: 1.1, 1.2, 1.3, 3.4_
  
  - [x] 2.2 インターネットゲートウェイとNATゲートウェイの作成
    - インターネットゲートウェイをVPCにアタッチ
    - 単一のNATゲートウェイをパブリックサブネットに配置
    - Elastic IPを割り当て
    - _要件: 1.4, 1.5, 7.3_
  
  - [x] 2.3 ルートテーブルの設定
    - パブリックサブネット用ルートテーブル（IGWへのルート）
    - プライベートサブネット用ルートテーブル（NATゲートウェイへのルート）
    - サブネットとルートテーブルの関連付け
    - _要件: 1.6_

- [x] 3. チェックポイント - ネットワーク構成の確認
  - terraform planを実行してネットワークリソースを確認
  - 質問があればユーザーに確認

- [x] 4. IAMロールとポリシーの実装
  - [x] 4.1 EKSクラスタ用IAMロールの作成
    - iam.tfを作成
    - EKSクラスタロールと信頼ポリシーを定義
    - AmazonEKSClusterPolicyをアタッチ
    - _要件: 2.4_
  
  - [x] 4.2 EKSノードグループ用IAMロールの作成
    - ノードグループロールと信頼ポリシーを定義
    - 必要なAWSマネージドポリシーをアタッチ（AmazonEKSWorkerNodePolicy、AmazonEKS_CNI_Policy、AmazonEC2ContainerRegistryReadOnly）
    - _要件: 2.4_
  
  - [x] 4.3 kyverno-notation-aws用IAMポリシーの作成
    - kyverno-notation-aws用のIAMポリシーを定義
    - AWS Signer検証用の権限を付与
    - ECRアクセス権限を付与
    - _要件: 2.4_

- [ ] 5. EKSクラスタとノードグループの実装
  - [x] 5.1 EKSクラスタの作成
    - eks.tfを作成
    - EKSクラスタリソースを定義（Kubernetes 1.28以上）
    - プライベートサブネットに配置
    - セキュリティグループを設定
    - _要件: 2.1, 2.5_
  
  - [x] 5.2 EKSノードグループの作成
    - コスト効率的な構成（desired=1, min=1, max=2）
    - 小型インスタンスタイプ（t3.small）を使用
    - プライベートサブネットに配置
    - 適切なタグを設定
    - _要件: 2.2, 2.3, 7.1, 7.2_

- [x] 6. ECRリポジトリの実装
  - ecr.tfを作成
  - ECRリポジトリを定義（nginx-signed）
  - イメージスキャンを有効化
  - ライフサイクルポリシーを設定（古いイメージの自動削除）
  - _要件: 2.6_

- [x] 7. チェックポイント - インフラストラクチャの確認
  - terraform planを実行して全リソースを確認
  - 質問があればユーザーに確認

- [ ] 8. READMEの作成 - 基本情報とTerraform手順
  - [x] 8.1 プロジェクト概要とアーキテクチャ説明
    - README.mdを作成
    - プロジェクトの目的と概要を記載
    - アーキテクチャ図または説明を追加
    - _要件: 8.1_
  
  - [x] 8.2 前提条件とコスト情報
    - 必要なツール（Terraform、AWS CLI、kubectl）を記載
    - AWSアカウントの要件を記載
    - 想定コスト（月額約$120）を記載
    - _要件: 7.5_
  
  - [x] 8.3 Terraform実行手順
    - AWS認証情報の設定方法を記載
    - terraform initコマンドを記載
    - terraform applyコマンドを記載
    - terraform destroyコマンドを記載
    - _要件: 8.1, 8.2, 8.3, 7.4_
  
  - [x] 8.4 kubectl設定手順
    - kubeconfigの更新コマンドを記載（aws eks update-kubeconfig）
    - クラスタ接続確認方法を記載
    - _要件: 8.4_

- [ ] 9. READMEの作成 - AWS Signer設定手順
  - [x] 9.1 AWS Signer署名プロファイルの作成手順
    - AWSマネジメントコンソールでの操作手順を記載
    - 署名プロファイルの作成方法を詳細に説明
    - スクリーンショットまたは詳細な手順を含める
    - _要件: 4.1, 4.5_
  
  - [x] 9.2 IAMポリシーとロールの設定手順
    - AWSマネジメントコンソールでの操作手順を記載
    - 必要なIAMポリシーの内容を記載
    - IAMロールの作成と権限付与の手順を記載
    - _要件: 4.2, 4.5_
  
  - [x] 9.3 コンテナイメージの署名手順
    - Nginxイメージのビルド手順を記載
    - AWS Signerを使用した署名コマンドを記載
    - 署名済みイメージのECRへのプッシュ手順を記載
    - _要件: 4.3, 4.4, 6.1_

- [x] 10. READMEの作成 - Kyverno + kyverno-notation-aws設定手順
  - [x] 10.1 cert-managerのインストール手順
    - cert-managerのインストールコマンドを記載
    - インストール確認方法を記載
    - _要件: 5.1_
  
  - [x] 10.2 Kyvernoのインストール手順
    - Helmを使用したKyvernoのインストールコマンドを記載
    - 必要な設定オプションを記載
    - _要件: 5.2_
  
  - [x] 10.3 kyverno-notation-awsアプリケーションのインストール
    - kyverno-notation-awsのインストール手順を記載
    - カスタムリソース定義（CRD）の適用を記載
    - _要件: 5.3_
  
  - [x] 10.4 TrustPolicyとTrustStoreの設定
    - TrustStoreリソースの作成手順を記載（AWS Signerルート証明書を含む）
    - TrustPolicyリソースの作成手順を記載
    - リソースの適用コマンドを記載
    - _要件: 5.4_
  
  - [x] 10.5 IRSA設定とServiceAccountの作成
    - kyverno-notation-aws用のIAMポリシー作成手順を記載
    - eksctlを使用したIRSA設定手順を記載
    - ServiceAccountの確認方法を記載
    - _要件: 5.5_
  
  - [x] 10.6 Kyvernoポリシーの作成と適用
    - check-imagesクラスタポリシーの作成手順を記載
    - TLS証明書の取得と設定方法を記載
    - ポリシーの適用コマンドを記載
    - _要件: 5.6_
  
  - [x] 10.7 ポリシーの動作確認方法
    - ポリシーの状態確認コマンドを記載
    - kyverno-notation-awsのログ確認方法を記載
    - _要件: 5.7_

- [x] 11. READMEの作成 - Nginxデプロイと検証手順
  - [x] 11.1 署名済みNginxのデプロイ手順
    - Kubernetesマニフェストの例を提供（署名済みイメージを使用）
    - kubectl applyコマンドを記載
    - デプロイ成功の確認方法を記載（kubectl get pods）
    - _要件: 6.2, 6.3, 6.4_
  
  - [x] 11.2 署名なしイメージでの失敗確認
    - 署名されていないイメージを使用したマニフェストの例を提供
    - デプロイ失敗の確認方法を記載
    - エラーメッセージの例を記載
    - _要件: 6.5_

- [x] 12. Kubernetesマニフェストファイルの作成
  - kubernetes/ディレクトリを作成
  - nginx-signed.yamlを作成（署名済みイメージ用）
  - nginx-unsigned.yamlを作成（検証用）
  - truststore.yamlを作成（AWS Signerルート証明書）
  - trustpolicy.yamlを作成（署名検証ポリシー）
  - kyverno-policy.yamlを作成（Kyvernoクラスタポリシー）
  - _要件: 6.2_

- [x] 13. 最終チェックポイント
  - 全てのファイルが作成されていることを確認
  - READMEの完全性を確認
  - 質問があればユーザーに確認

## 注意事項

- このプロジェクトはインフラストラクチャとドキュメントが中心のため、プロパティベーステストは実装しません
- 実際の環境でのテストは、ユーザーがREADMEの手順に従って手動で実施します
- コスト最適化のため、最小限のリソース構成を使用しています
- 本番環境への適用には、追加のセキュリティ設定とスケーラビリティの考慮が必要です
