apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: check-images
  annotations:
    policies.kyverno.io/title: Verify Container Image Signatures with AWS Signer
    policies.kyverno.io/category: Security
    policies.kyverno.io/severity: high
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      このポリシーは、AWS Signerで署名されたコンテナイメージのみがデプロイ可能であることを保証します。
      署名されていないイメージや、署名検証に失敗したイメージのデプロイは拒否されます。
      
      注意: このポリシーはkyverno-notation-awsアプリケーションと連携して動作します。
spec:
  validationFailureAction: Enforce
  webhookTimeoutSeconds: 30
  rules:
  - name: call-aws-signer-extension
    match:
      any:
      - resources:
          namespaces:
          - default
          kinds:
          - Pod
    context:
    - name: result
      apiCall:
        method: POST
        data:
        - key: images
          value: "{{ images }}"
        - key: trustPolicy
          value: "aws-signer-tp"
        service:
          url: https://kyverno-notation-aws-svc.kyverno-notation-aws.svc/checkimages
          caBundle: |-
            -----BEGIN CERTIFICATE-----
            MIIDtjCCAp6gAwIBAgIBATANBgkqhkiG9w0BAQsFADAYMRYwFAYDVQQDDA0qLmt5
            dmVybm8uc3ZjMB4XDTI2MDIxODE3MTMzOVoXDTI2MDcxODE4MTMzOVowIzEhMB8G
            A1UEAxMYa3l2ZXJuby1ub3RhdGlvbi1hd3Mtc3ZjMIIBIjANBgkqhkiG9w0BAQEF
            AAOCAQ8AMIIBCgKCAQEAqGIPW828W6wh1dAYPkgv6bC2M+/Kg8EvBqUzUIfMlFDJ
            3XLEf2KB7t0JLtg9l6nz9Gaej3/VTrqJQuUmWP1oRh+4XkXFf+oXqzKtd7z9Gwex
            HnhsjA+AlLxLnb39Nl+xMyrYhcOPrqF+lcevmUk9TzUbL9ZAMIp04mdjSZqS0Kkp
            AtdJvND2aToGnJ3hVfQhuysT/lQsUfh0D9gEey89KwSA6AIWLsr4PKcay0sVl4cK
            24sKN8IHMmyfStWKeTdFj2X+jBSuiIJOtO8ldaF6SGH7kh2VqgXc03dvQ+6OPyKi
            IvYC05P+CCrEu43YAsKrPTMx32IU5VhNzFuc5NLpTwIDAQABo4H/MIH8MA4GA1Ud
            DwEB/wQEAwIFoDATBgNVHSUEDDAKBggrBgEFBQcDATAMBgNVHRMBAf8EAjAAMB8G
            A1UdIwQYMBaAFKyK4RhWPhJC2uhA5t1jPcAijGeHMIGlBgNVHREEgZ0wgZqCGGt5
            dmVybm8tbm90YXRpb24tYXdzLXN2Y4Ita3l2ZXJuby1ub3RhdGlvbi1hd3Mtc3Zj
            Lmt5dmVybm8tbm90YXRpb24tYXdzgjFreXZlcm5vLW5vdGF0aW9uLWF3cy1zdmMu
            a3l2ZXJuby1ub3RhdGlvbi1hd3Muc3ZjghxzdmMua3l2ZXJuby1ub3RhdGlvbi1h
            d3Mtc3ZjMA0GCSqGSIb3DQEBCwUAA4IBAQBWd1kav8zgPUTuUMf7GZ8+8APL1Uzb
            LmBJ3eeK9QVEOX0Ajm/LQeUthMHJDyBdpgITTQ7LbYZTwsp+ikY1fZDIYaWZSCKh
            SV2dGhPN3hvEK76fZX2q0UH2+/8iZ1nT4daEzCcLpJfoJJSEIZz3Lo15SsWArWlw
            /Y/Y8PERwdyGNOrW/hCc00PjbxJNp+D3JXrEjqpKSpF3S6ZKxrvtV8GoVWFeVmeC
            ZErTZL1MUXHBDKE6740sNmtiPC8Xj1cNuYwgRkU4F5DRXc7vzcJmWrNkgbNX240G
            d7sBySFAwa7OMAklcbqpengNztyaKmT87/M6QBpaPxmNriU3/yuMB6mW
            -----END CERTIFICATE-----
            -----BEGIN CERTIFICATE-----
            MIIC7TCCAdWgAwIBAgIBADANBgkqhkiG9w0BAQsFADAYMRYwFAYDVQQDDA0qLmt5
            dmVybm8uc3ZjMB4XDTI2MDIxODE3MTMzOFoXDTI3MDIxODE4MTMzOFowGDEWMBQG
            A1UEAwwNKi5reXZlcm5vLnN2YzCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoC
            ggEBAOEiih8hjoO0EKR9r4t2rvtmqBfIihLjhmOgvim4myQ6jMcELTkklt5XgRm2
            ZrKskj+avCeU8ZcJfejcroUXYhbudgb1H72Ib6jwouI1GaDLCfiZzE+/PKIfgDiL
            foHyEvL4AXoloCprLWmJg1gc/dRI2q9mL0pFZCvYMLKbaQhcYWy37SZX0u4eYCt2
            g5AUrAoMaAwYn78Eg5NuHQZvJndt5U1PPjWQPmcVyVmqIdESHS58XVFxsS9SufYm
            ZRZ5mtEoViMPEmqSLECJlUvJAZBoyyHLCoNfMJMTUfeSpOK/NNrFGTbF8KAWREOA
            A8Fd7Nu4oYYBK9DEHnrXSxZl+zECAwEAAaNCMEAwDgYDVR0PAQH/BAQDAgKkMA8G
            A1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFKyK4RhWPhJC2uhA5t1jPcAijGeHMA0G
            CSqGSIb3DQEBCwUAA4IBAQAaWwrjv904Bd5BXaJGFdmMQMkzkAtzczQMCY3S8U3C
            SU/OOJHTuxfUtfOOWdZE59vf29JeyQqrzxmP/RuuWBwm4FRzZ2l1LnzOG1ls3/e4
            RuY8gmDq865gRt/WWqzsPGwMVogQ0J8gLdZWi5+E6925cXOFi07s9mYEGFJkzAcQ
            v8NguzeUpLQ63vDT5gV62Mk+rtKveg1vS5euvs54iZLTdpS8WXo8zTesJx6jQ8j2
            g9kFTb+7igtnuAr7yC5qHD1VswEzJaYDuhcxkNnKlrZYISMH9N8qd6y42QT6xSM6
            8iNNMueAJahlQ586rXLwzc/hYzIanVXOWrpF0ooxIIoA
            -----END CERTIFICATE-----
    validate:
      message: "署名検証に失敗しました。署名されたイメージのみがデプロイ可能です。"
      deny:
        conditions:
          all:
          - key: "{{ result.verified }}"
            operator: Equals
            value: false
